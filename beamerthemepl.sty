% Beamer mtheme
%
% Copyright 2014 Matthias Vogelgesang
% Licensed under CC-BY-SA 4.0 International.
%
% The initial template comes from the HSRM beamer theme by Benjamin Weiss, which
% you can find at https://github.com/hsrmbeamertheme/hsrmbeamertheme.
%

\ProvidesPackage{beamerthemepl}

%{{{ --- Options ----------------------

\newif\if@useTitleProgressBar
\newif\if@protectFrameTitle

\@useTitleProgressBartrue
\@protectFrameTitlefalse

\newlength{\@mtheme@voffset}
\setlength{\@mtheme@voffset}{1.4em}

\DeclareOptionBeamer{noprogressbar}{\@useTitleProgressBarfalse}
\DeclareOptionBeamer{protectframetitle}{\@protectFrameTitletrue}
\DeclareOptionBeamer{blockbg}{%
  \PassOptionsToPackage{blockbg}{beamercolorthemepl}%
}
\DeclareOptionBeamer{nooffset}{\setlength{\@mtheme@voffset}{0em}}

\DeclareOptionBeamer*{%
  \PackageWarning{beamerthemem}{Unknown option `\CurrentOption'}%
}

\ProcessOptionsBeamer

%}}}

\mode<presentation>

%{{{ --- Packages ---------------------

\RequirePackage{etoolbox}
\RequirePackage{tikz}
\RequirePackage{pgfplots}
\RequirePackage{minted}
\RequirePackage{graphicx}
\RequirePackage[scale=2]{ccicons}
\RequirePackage[absolute, overlay]{textpos}

\usetikzlibrary{backgrounds}
\usetikzlibrary{calc}

\usecolortheme{pl}
\usefonttheme{pl}

%}}}

\newcommand{\reference}[1]{%
  \begin{tikzpicture}[remember picture, overlay]%
    \node[anchor=south west,] at (current page.south west) {\color{plFG}\tiny #1};%
  \end{tikzpicture}%
}

%{{{ --- Titlepage --------------------

\pgfdeclareimage[height=1.2\paperheight]{titlebackground}{background.png}

\def\maketitle{\ifbeamer@inframe\titlepage\else\frame[plain]{\titlepage}\fi}

\def\titlepage{\usebeamertemplate{title page}}
\setbeamertemplate{title page}
{
\begin{picture}(0,0)
  \put(-28.5,-175){%
      \pgfuseimage{titlebackground}
  }
  \put(398, 100){\color{white}\tiny\ccby}%
  \put(0,-145){%
      \begin{minipage}[b][4.5cm][t]{0.5\textwidth}
          \color{white}
              {\usebeamerfont{title}\inserttitle\\[0.2cm]}
              {\usebeamerfont{subtitle}\insertsubtitle\\[0.9cm]}
              \vfill
              {\usebeamerfont{author}\insertauthor \hfil \usebeamerfont{institute}\insertinstitute\par}
              {\usebeamerfont{date}\insertdate}
      \end{minipage}
  }
\end{picture}
}

%}}}
%{{{ --- Progressbar ------------------

\makeatletter
\def\progressbar@sectionprogressbar{}
\def\progressbar@titleprogressbar{}
\newcount\progressbar@tmpcounta % auxiliary counter
\newcount\progressbar@tmpcountb % auxiliary counter
\newdimen\progressbar@pbht      % progressbar height
\newdimen\progressbar@pbwd      % progressbar width
\newdimen\progressbar@tmpdim    % auxiliary dimension

\progressbar@pbwd=0.4\textwidth
\progressbar@pbht=0.7pt

% the progress bar
\def\progressbar@sectionprogressbar{%
  {\usebeamercolor{palette quaternary}%
    \progressbar@tmpcounta=\insertframenumber
    \progressbar@tmpcountb=\inserttotalframenumber
    \progressbar@tmpdim=\progressbar@pbwd
    \divide\progressbar@tmpdim by 100
    \multiply\progressbar@tmpdim by \progressbar@tmpcounta
    \divide\progressbar@tmpdim by \progressbar@tmpcountb
    \multiply\progressbar@tmpdim by 100

    \fontsize{1em}{1em}\selectfont

    \makebox[\textwidth][c]{
      \begin{tikzpicture}[tight background]

        \node[anchor=south west, fg, inner sep=0pt, text width=\progressbar@pbwd] at (0pt, 0pt) {\color{plAC!15!plFG}\large\bfseries\insertsectionHEAD\par};

        \vspace{\@mtheme@voffset}%

        \draw[palette quaternary.bg, fill=palette quaternary.bg, rounded corners = 0.1pt]
        (0, -2ex) rectangle ++ (\progressbar@pbwd, \progressbar@pbht);

        \draw[palette quaternary.fg, fill=palette quaternary.fg, rounded corners = 0.1pt]
        (0, -2ex) rectangle ++ (\progressbar@tmpdim, \progressbar@pbht);
      \end{tikzpicture}%
    }
  }
}

\if@useTitleProgressBar
\def\progressbar@titleprogressbar{%
  \progressbar@tmpcounta=\insertframenumber
  \progressbar@tmpcountb=\inserttotalframenumber
  \progressbar@tmpdim=0.5\textwidth
  \divide\progressbar@tmpdim by 100
  \multiply\progressbar@tmpdim by \progressbar@tmpcounta
  \divide\progressbar@tmpdim by \progressbar@tmpcountb
  \multiply\progressbar@tmpdim by 100
  {%
    \usebeamercolor{palette quaternary}%
    \begin{tikzpicture}[tight background]
      \draw[palette quaternary.bg, fill=palette quaternary.bg, rounded corners = 0.1pt] (0, 0) rectangle ($(\progressbar@pbwd, \progressbar@pbht) - (0, 0)$);
      \draw[palette quaternary.fg, fill=palette quaternary.fg, rounded corners = 0.1pt] (0, 0) rectangle (\progressbar@tmpdim, \progressbar@pbht);
    \end{tikzpicture}%
  }%
}
\fi
%}}}
%{{{ --- Commands ---------------------

\newcommand{\insertsectionHEAD}{%
  \expandafter\insertsectionHEADaux\insertsectionhead}
  \newcommand{\insertsectionHEADaux}[3]{#3}

%}}}
%{{{ --- Itemize ----------------------

\setlength{\leftmargini}{1em}

% Actually one level should be enough but ...
\setlength{\leftmarginii}{1em}
\setlength{\leftmarginiii}{1em}

\newcommand{\itemBullet}{$\cdot$}

\setbeamertemplate{itemize item}{\itemBullet}
\setbeamertemplate{itemize subitem}{\itemBullet}
\setbeamertemplate{itemize subsubitem}{\itemBullet}
\setlength{\parskip}{0.5em}

%}}}

%{{{ --- Sections ---------------------

% Insert frame with section title at every section start
\AtBeginSection[]
{
  \begingroup
    \setbeamercolor{background canvas}{parent=palette primary}
    \begin{frame}[plain]
      \begin{picture}(0,0)
        \put(-28.5,-175){%
          \pgfuseimage{titlebackground}
        }
        \put(-28.5,-175){%
          \tikz \fill [plBG, opacity=0.92] (1,1) rectangle (10,12);
        }
        \put(0,-145){%
          \begin{minipage}[b][4.5cm][t]{0.5\textwidth}
            \progressbar@sectionprogressbar%
          \end{minipage}
        }
      \end{picture}
    \end{frame}
  \endgroup
}


%}}}

%{{{ --- Captions ---------------------

\setbeamertemplate{caption label separator}{: }
\setbeamertemplate{caption}[numbered]

%}}}

%{{{ --- Footline/footnote ------------

\usenavigationsymbolstemplate{}
\setbeamertemplate{footline}
{%
\vspace{\@mtheme@voffset}
}

\setbeamertemplate{footnote}
{%
  \parindent 0em\noindent%
  \raggedright
  \usebeamercolor{footnote}\hbox to 0.8em{\hfil\insertfootnotemark}\insertfootnotetext\par%
}

%}}}

%{{{ --- Frametitle -------------------

\setbeamertemplate{frametitle}{%
\vspace{\@mtheme@voffset}%
\if@protectFrameTitle%
\usebeamerfont{frametitle}\protect\insertframetitle\\
\else%
\usebeamerfont{frametitle}\insertframetitle\\
\fi%
\if@useTitleProgressBar%
\vspace{\@mtheme@voffset}%
\begin{beamercolorbox}[wd=\textwidth,ht=1pt,dp=0pt]{frametitle}%
  \progressbar@titleprogressbar%
\end{beamercolorbox}%
\fi%
\vspace{\@mtheme@voffset}%
}

%}}}
%{{{ Styles

\pgfplotsset{
  compat=1.12,
  scale only axis,
  tick align=outside,
  every axis/.append style={
    line width=0.2pt,
    font=\normalsize\bfseries\rmfamily,
    plFG,
  },
  xlabel style={
     at={(ticklabel cs:0)},
     anchor=north west,
  },
  ylabel style={
     at={(ticklabel cs:0)},
     anchor=south west,
  },
  tick label style={
    font=\small\mdseries,
    plFG,
  },
  major grid style={
    dotted,
    plFG!50!plBG
  },
  disable thousands separator/.style={
    /pgf/number format/.cd,
      1000 sep={}
  }
}

%}}}

\mode<all>

%{{{ misc
\let\otp\titlepage
\renewcommand{\titlepage}{\otp\addtocounter{framenumber}{-1}}
\newcommand{\mreducelistspacing}{\vspace{-\topsep}}

\linespread{1.15}

%}}}

% Beamer mtheme
%
% Copyright 2014 Matthias Vogelgesang
% Licensed under CC-BY-SA 4.0 International.
%
% The initial template comes from the HSRM beamer theme by Benjamin Weiss, which
% you can find at https://github.com/hsrmbeamertheme/hsrmbeamertheme.
%

\ProvidesPackage{beamerthemepl}

%{{{ --- Options ----------------------

\newif\if@useTitleProgressBar
\newif\if@protectFrameTitle

\@useTitleProgressBartrue
\@protectFrameTitlefalse

\newlength{\@mtheme@voffset}
\setlength{\@mtheme@voffset}{1.1em}

\DeclareOptionBeamer{noprogressbar}{\@useTitleProgressBarfalse}
\DeclareOptionBeamer{protectframetitle}{\@protectFrameTitletrue}
\DeclareOptionBeamer{blockbg}{%
  \PassOptionsToPackage{blockbg}{beamercolorthemepl}%
}
\DeclareOptionBeamer{nooffset}{\setlength{\@mtheme@voffset}{0em}}

\DeclareOptionBeamer*{%
  \PackageWarning{beamerthemem}{Unknown option `\CurrentOption'}%
}

\ProcessOptionsBeamer

%}}}

\mode<presentation>

%{{{ --- Packages ---------------------

\RequirePackage[utf8]{inputenc}
\RequirePackage{etoolbox}
\RequirePackage{tikz}
\RequirePackage{pgfplots}
\RequirePackage{minted}
\RequirePackage{graphicx}
\RequirePackage[absolute, overlay]{textpos}

\usetikzlibrary{backgrounds}
\usetikzlibrary{calc}

\usecolortheme{pl}
\usefonttheme{pl}

%}}}

\newcommand{\reference}[1]{%
  \begin{tikzpicture}[remember picture, overlay]%
    \node[anchor=south west,] at (current page.south west) {\color{plFG}\tiny #1};%
  \end{tikzpicture}%
}

%{{{ --- Titlepage --------------------

\def\maketitle{\ifbeamer@inframe\titlepage\else\frame[plain]{\titlepage}\fi}

\def\titlepage{\usebeamertemplate{title page}}
\setbeamertemplate{title page}
{
  \vspace*{\@mtheme@voffset}
  {\hfill\color{plFG}\scriptsize\ccby}
      \vfill \vfil \vfill
      \vfill \vfil \vfill
      \vfil
      \vfil
      \vfil
      \ifx\inserttitle\@empty%
      \else%
      {\raggedright\linespread{1.0}\usebeamerfont{title}\usebeamercolor[fg]{title}\inserttitle\par}%
      \vspace*{0.5em}
      \fi%
      \ifx\insertsubtitle\@empty%
      \else%
      {\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}%
      \vspace*{0.5em}
      \fi%
      \vspace*{1em}
      \ifx\insertauthor\@empty%
      \else%
      {\usebeamerfont{author}\usebeamercolor[fg]{author}\insertauthor\par}%
      \vspace*{0.25em}
      \fi%
      \ifx\insertdate\@empty%
      \else%
      {\usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate\par}%
      \fi%
      \ifx\insertinstitut\@empty%
      \else%
      \vspace*{3mm}
      {\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute\par}%
      \fi%
      \vspace*{\@mtheme@voffset}
}

%}}}
%{{{ --- Progressbar ------------------

\makeatletter
\def\progressbar@sectionprogressbar{}
\def\progressbar@titleprogressbar{}
\newcount\progressbar@tmpcounta % auxiliary counter
\newcount\progressbar@tmpcountb % auxiliary counter
\newdimen\progressbar@pbht      % progressbar height
\newdimen\progressbar@pbwd      % progressbar width
\newdimen\progressbar@tmpdim    % auxiliary dimension

\progressbar@pbwd=0.5\textwidth
\progressbar@pbht=1.8pt

% the progress bar
\def\progressbar@sectionprogressbar{%
  {\usebeamercolor{palette quaternary}%
    \progressbar@tmpcounta=\insertframenumber
    \progressbar@tmpcountb=\inserttotalframenumber
    \progressbar@tmpdim=\progressbar@pbwd
    \divide\progressbar@tmpdim by 100
    \multiply\progressbar@tmpdim by \progressbar@tmpcounta
    \divide\progressbar@tmpdim by \progressbar@tmpcountb
    \multiply\progressbar@tmpdim by 100

    % fixes very high linespacing introduced via \textsc{\MakeLowercase{...}}
    \fontsize{1em}{1em}\selectfont

    \makebox[\textwidth][c]{
      \begin{tikzpicture}[tight background]

        \node[anchor=south west, fg, inner sep=0pt, text width=\progressbar@pbwd] at (0pt, 0pt) {\color{plFG}\insertsectionHEAD};

        \vspace{\@mtheme@voffset}%

        \draw[palette quaternary.bg, fill=palette quaternary.bg, rounded corners = 0.5pt]
        (0, -1ex) rectangle ++ (\progressbar@pbwd, \progressbar@pbht);

        \draw[palette quaternary.fg, fill=palette quaternary.fg, rounded corners = 0.5pt]
        (0, -1ex) rectangle ++ (\progressbar@tmpdim, \progressbar@pbht);
      \end{tikzpicture}%
    }
  } % end usebeamercolor{palette primary}
}

\if@useTitleProgressBar
\def\progressbar@titleprogressbar{%
  \progressbar@tmpcounta=\insertframenumber
  \progressbar@tmpcountb=\inserttotalframenumber
  \progressbar@tmpdim=0.5\textwidth
  \divide\progressbar@tmpdim by 100
  \multiply\progressbar@tmpdim by \progressbar@tmpcounta
  \divide\progressbar@tmpdim by \progressbar@tmpcountb
  \multiply\progressbar@tmpdim by 100
  {%
    \usebeamercolor{palette quaternary}%
    \begin{tikzpicture}[tight background]
      \draw[palette quaternary.bg, fill=palette quaternary.bg, rounded corners = 0.5pt] (0, 0) rectangle ($(\progressbar@pbwd, \progressbar@pbht) - (0.4pt, 0)$);
      \draw[palette quaternary.fg, fill=palette quaternary.fg, rounded corners = 0.5pt] (0, 0) rectangle (\progressbar@tmpdim, \progressbar@pbht);
    \end{tikzpicture}%
  }%
}
\fi
%}}}
%{{{ --- Commands ---------------------

\newcommand{\insertsectionHEAD}{%
  \expandafter\insertsectionHEADaux\insertsectionhead}
  \newcommand{\insertsectionHEADaux}[3]{#3
}

\newcommand{\plain}[2][]{%
  \begingroup
  \setbeamercolor{background canvas}{fg=plLO,bg=plTX}
  \begin{frame}{#1}
    \centering
    \vfill\vspace{1em}\usebeamerfont{section title}\textcolor{plHI}{\MakeUppercase{#2}}\vfill
  \end{frame}
  \endgroup
}

%}}}
%{{{ --- Itemize ----------------------

\setlength{\leftmargini}{1em}

% Actually one level should be enough but ...
\setlength{\leftmarginii}{1em}
\setlength{\leftmarginiii}{1em}

\newcommand{\itemBullet}{$\cdot$}

\setbeamertemplate{itemize item}{\itemBullet}
\setbeamertemplate{itemize subitem}{\itemBullet}
\setbeamertemplate{itemize subsubitem}{\itemBullet}
\setlength{\parskip}{0.5em}

%}}}
%{{{ --- Sections ---------------------

% Insert frame with section title at every section start
\AtBeginSection[]
{
  \begingroup
  \setbeamercolor{background canvas}{parent=palette primary}
  \begin{frame}[plain]
    \vspace{2em}\usebeamerfont{section title}
    \progressbar@sectionprogressbar%
  \end{frame}
  \endgroup
}

%}}}
%{{{ --- Captions ---------------------

\setbeamertemplate{caption label separator}{: }
\setbeamertemplate{caption}[numbered]

%}}}
%{{{ --- Footline/footnote ------------

\usenavigationsymbolstemplate{}
\setbeamertemplate{footline}
{%
\vspace{\@mtheme@voffset}
%\begin{beamercolorbox}[wd=\textwidth,ht=3ex,dp=3ex,leftskip=0.3cm,rightskip=0.3cm]{structure}%
%  \hfill\usebeamerfont{page number in head/foot}%
%  \insertframenumber%
%\end{beamercolorbox}%
}

\setbeamertemplate{footnote}
{%
  \parindent 0em\noindent%
  \raggedright
  \usebeamercolor{footnote}\hbox to 0.8em{\hfil\insertfootnotemark}\insertfootnotetext\par%
}

%}}}
%{{{ --- Frametitle -------------------

\setbeamertemplate{frametitle}{%
%\nointerlineskip%
\vspace{\@mtheme@voffset}%
%\begin{beamercolorbox}[wd=\textwidth,leftskip=0cm,rightskip=0cm,ht=1em,dp=1.5ex]{frametitle}%
\if@protectFrameTitle%
\usebeamerfont{frametitle}\protect\insertframetitle\\%\MakeUppercase{\insertframetitle}%
\else%
\usebeamerfont{frametitle}\insertframetitle\\%\MakeUppercase{\insertframetitle}% \MakeUppercase or \MakeLowercase
\fi%
\if@useTitleProgressBar%
\vspace{\@mtheme@voffset}%
\vspace{-1.3em}%
\begin{beamercolorbox}[wd=\textwidth,ht=1pt,dp=0pt]{frametitle}%
  \progressbar@titleprogressbar%
\end{beamercolorbox}%
\fi%
%\end{beamercolorbox}%
\vspace{\@mtheme@voffset}%
}

%}}}
%{{{ --- pgfplots ---------------------

%{{{ Color cycles

\pgfplotscreateplotcyclelist{plLineSymbol cycle}{%
  {draw=plMD, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plMD, very thick, mark = square*, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plMD, very thick, mark = triangle*, mark size=2.9pt, every mark/.append style={fill=plBG}},
  {draw=plMD, very thick, mark = diamond*, mark size=2.9pt, every mark/.append style={fill=plBG}},
}

\pgfplotscreateplotcyclelist{plLineType cycle}{%
  {draw=plMD, very thick, solid},
  {draw=plMD, very thick, dashed},
  {draw=plMD, very thick, dotted},
  {draw=plMD, very thick, dashdotted},
}

\pgfplotscreateplotcyclelist{plLineColor cycle}{%
  {draw=plLO, very thick, solid},
  {draw=plMD, very thick, solid},
  {draw=plHI, very thick, solid},
}

\pgfplotscreateplotcyclelist{plSymbol cycle}{%
  {draw=plMD, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plMD, only marks, very thick, mark = square*, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plMD, only marks, very thick, mark = triangle*, mark size=2.9pt, every mark/.append style={fill=plBG}},
  {draw=plMD, only marks, very thick, mark = diamond*, mark size=2.9pt, every mark/.append style={fill=plBG}},
}

\pgfplotscreateplotcyclelist{plSymbolColor cycle}{%
  {draw=plLO, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plMD, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plHI, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
}

\pgfplotscreateplotcyclelist{plSymbolFilled cycle}{%
  {draw=plLO, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plLO!50!plBG}},
  {draw=plMD, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plMD!50!plBG}},
  {draw=plHI, only marks, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plHI!50!plBG}},
}

\pgfplotscreateplotcyclelist{plLineSymbolColor cycle}{%
  {draw=plLO, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plMD, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
  {draw=plHI, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plBG}},
}

\pgfplotscreateplotcyclelist{plLineSymbolFilled cycle}{%
  {draw=plLO, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plLO!50!plBG}},
  {draw=plMD, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plMD!50!plBG}},
  {draw=plHI, very thick, mark = *, mark size=2.1pt, every mark/.append style={fill=plHI!50!plBG}},
}

\pgfplotscreateplotcyclelist{plBarColors cycle}{%
  {draw=plLO, very thin, fill=plLO},
  {draw=plMD, very thin, fill=plMD},
  {draw=plHI, very thin, fill=plHI},
}


%}}}
%{{{ Styles

\pgfplotsset{
  compat=1.9,
  scale only axis,
  tick align=outside,
  every axis/.append style={
    line width=0.2pt,
    font=\small,
    plTX,
  },
  tick label style={
    font=\tiny,
    plFG,
  },
  major grid style={
    dotted,
    plFG!50!plBG
  },
  disable thousands separator/.style={
    /pgf/number format/.cd,
      1000 sep={}
  },
  plLineGraph/.style = {
    scaled ticks = false,
    axis lines = left,
  },
  plCenteredAxes/.style = {
    scaled ticks = false,
    axis lines = middle,
    axis equal,
  },
  plNoAxes/.style = {
    axis x line*=bottom,
    axis y line*=left,
    x axis line style={plBG, line width=2pt},
    y axis line style={plBG, line width=2pt},
    trim axis left, trim axis right,
  },
  plBarPlot/.style = {
    bar width = 5pt,
  },
  plVerticalBarPlot/.style = {
    plBarPlot,
    ybar = 1pt,
    ymin = 0,
    axis x line*=bottom,
    axis y line*=left,
    y axis line style={plBG, line width=1pt},
    trim axis left, trim axis right,
  },
  plHorizontalBarPlot/.style = {
    plBarPlot,
    xbar = 1pt,
    xmin = 0,
    axis x line*=bottom,
    axis y line*=left,
    x axis line style={plBG, line width=1pt},
    trim axis left, trim axis right,
  },
  plSurfacePlot/.style = {
    colorbar,
    colormap={plcm}{color=(plLO!10) color=(plHI)},
    tick align=inside,
    shader=faceted,
    faceted color=mapped color!70!plFG,
    major grid style={
      solid,
      plFG!50!plBG
    }
  }
}

%}}}

\mode<all>

%{{{ misc
\let\otp\titlepage
\renewcommand{\titlepage}{\otp\addtocounter{framenumber}{-1}}
\newcommand{\mreducelistspacing}{\vspace{-\topsep}}

\linespread{1.15}

%}}}
